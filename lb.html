<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mango Social</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Sacramento&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            background: linear-gradient(45deg, #1a0033, #330066, #4d0099);
            min-height: 100vh;
            font-family: 'Orbitron', sans-serif;
            color: #fff;
            overflow-y: auto;
            margin: 0;
            padding: 2vw;
        }
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: url('https://images.pexels.com/photos/957040/night-sky-stars-milky-way-cosmos-957040.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1');
            background-size: cover;
            opacity: 0.25;
            animation: cosmicPulse 20s infinite ease-in-out;
            z-index: -1;
        }
        .app {
            background: rgba(255, 255, 255, 0.15);
            width: 90vw;
            max-width: 700px;
            border-radius: 20px;
            padding: 3vw;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 40px rgba(255, 153, 255, 0.4);
            margin: 0 auto;
        }
        input, textarea, button {
            width: 100%;
            margin: 1vw 0;
            padding: 1.5vw;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            font-family: 'Orbitron', sans-serif;
            box-sizing: border-box;
            font-size: clamp(12px, 2vw, 16px);
        }
        textarea {
            resize: vertical;
            min-height: 10vw;
        }
        button {
            background: linear-gradient(45deg, #ff66ff, #66ffff);
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 1vw 2vw;
        }
        button:hover {
            transform: scale(1.02);
            box-shadow: 0 0 15px rgba(255, 153, 255, 0.6);
        }
        .profile-section {
            text-align: center;
            margin-bottom: 2vw;
            padding-bottom: 2vw;
            border-bottom: 1px solid rgba(255, 255, 255, 0.4);
            position: relative;
        }
        .profile-dp {
            width: clamp(60px, 15vw, 100px);
            height: clamp(60px, 15vw, 100px);
            border-radius: 50%;
            object-fit: cover;
            object-position: center;
            position: absolute;
            top: clamp(-40px, -8vw, -60px);
            left: 50%;
            transform: translateX(-50%);
            border: 2px solid rgba(255, 255, 255, 0.6);
        }
        .post-dp, .comment-dp {
            width: clamp(30px, 6vw, 40px);
            height: clamp(30px, 6vw, 40px);
            border-radius: 50%;
            object-fit: cover;
            object-position: center;
            margin-right: 1vw;
        }
        .post-content img {
            max-width: 100%;
            max-height: 40vw;
            object-fit: contain;
            margin-top: 1vw;
        }
        .delete-btn, .like-btn, .comment-btn {
            margin: 0.5vw;
            padding: 0.5vw;
            font-size: clamp(14px, 2.5vw, 16px);
            width: auto;
            display: inline-block;
            min-width: 30px;
        }
        .timestamp {
            font-size: clamp(10px, 1.5vw, 12px);
            color: #ccc;
        }
        .feed {
            overflow-y: auto;
            padding-right: 1vw;
        }
        .post {
            background: rgba(255, 255, 255, 0.2);
            padding: 2vw;
            margin: 2vw 0;
            border-radius: 10px;
            display: flex;
            align-items: flex-start;
            border: 1px solid rgba(255, 255, 255, 0.4);
        }
        .comment {
            background: rgba(255, 255, 255, 0.15);
            padding: 1.5vw;
            margin: 1vw 0 0 clamp(20px, 5vw, 50px);
            border-radius: 8px;
            display: flex;
            align-items: flex-start;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        @keyframes cosmicPulse {
            0%, 100% { opacity: 0.25; }
            50% { opacity: 0.35; }
        }
        @media (max-width: 600px) {
            .app {
                padding: 4vw;
            }
            .post, .comment {
                flex-direction: column;
                align-items: stretch;
            }
            .post-dp, .comment-dp {
                margin-bottom: 1vw;
            }
            button {
                padding: 2vw 3vw;
            }
        }
    </style>
</head>
<body>
    <div id="loginContainer" class="app">
        <h1>Login to Mango Social</h1>
        <form id="loginForm">
            <label for="username">Username:</label>
            <input type="text" id="username" placeholder="mango1 or mango2" required>
            <label for="password">Password:</label>
            <input type="password" id="password" placeholder="mango1726" required>
            <button type="submit">Login</button>
        </form>
    </div>

    <div id="mainContainer" class="app" style="display: none;">
        <div class="profile-section">
            <img id="profilePicture" alt="Profile Picture" class="profile-dp">
            <h2 id="profileUsername"></h2>
            <p id="profileBio"></p>
            <button id="editProfileBtn" class="btn">Edit Profile</button>
            <button id="logoutBtn" class="btn">Logout</button>
            <button id="clearDataBtn" class="btn">Clear All Data</button>
        </div>

        <form id="editProfileForm" style="display: none;">
            <input type="text" id="editUsername" placeholder="Username">
            <textarea id="editBio" placeholder="Bio"></textarea>
            <input type="file" id="editProfilePic" accept="image/*">
            <button type="submit">Save Profile</button>
        </form>

        <form id="postForm">
            <textarea id="postContent" placeholder="What's on your mind?"></textarea>
            <input type="file" id="postImage" accept="image/*">
            <button type="submit">Post</button>
        </form>

        <div id="posts" class="feed"></div>
    </div>

    <script>
        const supabaseUrl = 'https://rukbvbwjfyktrdvvodir.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1a2J2YndqZnlrdHJkdnZvZGlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE3MDE1NjAsImV4cCI6MjA1NzI3NzU2MH0._A8EPmKwdaGnFhvhiZJUZ3nvkQrKkCfzmiOhO8JC1vc';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        console.log('Supabase client initialized:', supabase ? 'Success' : 'Failed');

        const users = [
            { id: '566e8b0b-a07a-4442-b18d-2a3ca87f7992', username: 'mango1', password: 'mango1726', bio: '', profile_picture: '' },
            { id: 'f960d7a8-ec35-4ff6-910a-6571c8b74caa', username: 'mango2', password: 'mango1726', bio: '', profile_picture: '' }
        ];

        const placeholderImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAAAXNSR0IArs4c6QAAAJBJREFUOE9jZKAyYCRkZGQgy8DAwMDAwMjAwMjIyMDAwMDAwMjAwMjIyMDAwMDAwMjAwMjIyMDAwMDAwMjAwMjIyMDAwMDAwMjAwMjIyMDAwMDAwMjAwMjIyMDAwMDAwMjAwMjIyMDAwMDAwMjAwMjIyMDAwMDAwMjAwMjIyMDAwMDAwMjAwMjIyMDAwMDAwMjAwMjIyMAAAADs=';

        document.addEventListener('DOMContentLoaded', () => {
            const isFreshLogin = sessionStorage.getItem('justLoggedIn');
            if (!isFreshLogin) {
                localStorage.removeItem('loggedInUser');
                document.getElementById('loginContainer').style.display = 'block';
                document.getElementById('mainContainer').style.display = 'none';
            } else {
                const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
                if (loggedInUser) {
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('mainContainer').style.display = 'block';
                    loadProfile(loggedInUser);
                    loadFeed();
                }
            }
            subscribeToUpdates();

            document.getElementById('loginForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                console.log('Login attempt:', { username, password });

                const user = users.find(u => u.username === username && u.password === password);
                if (user) {
                    localStorage.setItem('loggedInUser', JSON.stringify(user));
                    sessionStorage.setItem('justLoggedIn', 'true');
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('mainContainer').style.display = 'block';
                    loadProfile(user);
                    loadFeed();
                } else {
                    alert('Invalid credentials. Use mango1 or mango2 with password mango1726.');
                }
            });

            document.getElementById('logoutBtn').addEventListener('click', () => {
                localStorage.removeItem('loggedInUser');
                sessionStorage.removeItem('justLoggedIn');
                document.getElementById('mainContainer').style.display = 'none';
                document.getElementById('loginContainer').style.display = 'block';
                console.log('Logged out');
            });

            document.getElementById('editProfileBtn').addEventListener('click', () => {
                const user = JSON.parse(localStorage.getItem('loggedInUser'));
                document.getElementById('editUsername').value = user.username;
                document.getElementById('editBio').value = user.bio || '';
                document.getElementById('editProfileForm').style.display = 'block';
            });

            document.getElementById('editProfileForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = JSON.parse(localStorage.getItem('loggedInUser'));
                const newUsername = document.getElementById('editUsername').value;
                const newBio = document.getElementById('editBio').value;
                const file = document.getElementById('editProfilePic').files[0];
                let profilePictureUrl = user.profile_picture || placeholderImage;

                if (file) {
                    const filePath = `${user.id}/${Date.now()}_${file.name}`;
                    const { error } = await supabase.storage
                        .from('profile-pics')
                        .upload(filePath, file, { upsert: true });
                    if (error) {
                        console.error('Upload error:', error.message);
                        alert('Failed to upload profile picture: ' + error.message);
                    } else {
                        profilePictureUrl = supabase.storage.from('profile-pics').getPublicUrl(filePath).data.publicUrl;
                        console.log('Profile pic URL:', profilePictureUrl);
                    }
                }

                user.username = newUsername;
                user.bio = newBio;
                user.profile_picture = profilePictureUrl;
                localStorage.setItem('loggedInUser', JSON.stringify(user));

                const { error } = await supabase.from('users').upsert({
                    id: user.id,
                    username: newUsername,
                    bio: newBio,
                    profile_picture: profilePictureUrl
                }, { onConflict: 'id' });
                if (error) {
                    console.error('Upsert error:', error.message);
                    alert('Failed to update profile: ' + error.message);
                }

                loadProfile(user);
                loadFeed();
                document.getElementById('editProfileForm').style.display = 'none';
            });

            document.getElementById('postForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = JSON.parse(localStorage.getItem('loggedInUser'));
                const content = document.getElementById('postContent').value.trim();
                const file = document.getElementById('postImage').files[0];
                let imageUrl = null;

                if (!content && !file) {
                    alert('Please enter some content or upload an image.');
                    return;
                }

                if (file) {
                    const filePath = `${user.id}/${Date.now()}_${file.name}`;
                    const { error } = await supabase.storage
                        .from('profile-pics')
                        .upload(filePath, file, { upsert: true });
                    if (error) {
                        console.error('Upload error:', error.message);
                        alert('Failed to upload image: ' + error.message);
                    } else {
                        imageUrl = supabase.storage.from('profile-pics').getPublicUrl(filePath).data.publicUrl;
                        console.log('Post image URL:', imageUrl);
                    }
                }

                const { data, error } = await supabase
                    .from('posts')
                    .insert([{ user_id: user.id, content: content || '', image: imageUrl }])
                    .select();
                if (error) {
                    console.error('Post error:', error.message);
                    alert('Failed to post: ' + error.message);
                } else {
                    console.log('Post successful:', data);
                    document.getElementById('postForm').reset();
                    loadFeed();
                }
            });

            document.getElementById('clearDataBtn').addEventListener('click', async () => {
                if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                    const { error: likesError } = await supabase.from('likes').delete().match({});
                    if (likesError) console.error('Delete likes error:', likesError.message);

                    const { error: commentsError } = await supabase.from('comments').delete().match({});
                    if (commentsError) console.error('Delete comments error:', commentsError.message);

                    const { error: postsError } = await supabase.from('posts').delete().match({});
                    if (postsError) console.error('Delete posts error:', postsError.message);

                    const { data: files, error: listError } = await supabase.storage.from('profile-pics').list();
                    if (listError) {
                        console.error('List files error:', listError.message);
                    } else if (files && files.length > 0) {
                        const fileNames = files.map(file => file.name);
                        const { error: removeError } = await supabase.storage.from('profile-pics').remove(fileNames);
                        if (removeError) console.error('Remove files error:', removeError.message);
                    }

                    const user = JSON.parse(localStorage.getItem('loggedInUser'));
                    user.profile_picture = placeholderImage;
                    user.bio = '';
                    localStorage.setItem('loggedInUser', JSON.stringify(user));
                    const { error: upsertError } = await supabase.from('users').upsert({ 
                        id: user.id, 
                        username: user.username, 
                        bio: '', 
                        profile_picture: placeholderImage 
                    }, { onConflict: 'id' });
                    if (upsertError) console.error('Upsert user error:', upsertError.message);

                    console.log('All data cleared');
                    loadProfile(user);
                    loadFeed();
                }
            });
        });

        async function loadProfile(user) {
            const { data, error } = await supabase
                .from('users')
                .select('username, bio, profile_picture')
                .eq('id', user.id)
                .single();
            if (error && error.code !== 'PGRST116') {
                console.error('Load profile error:', error.message);
                alert('Failed to load profile: ' + error.message);
            }
            const profileData = data || user;
            document.getElementById('profileUsername').textContent = profileData.username;
            document.getElementById('profileBio').textContent = profileData.bio || 'No bio yet';
            const profilePic = document.getElementById('profilePicture');
            profilePic.src = profileData.profile_picture || placeholderImage;
            console.log('Profile picture set to:', profilePic.src);
        }

        async function loadFeed() {
            const { data, error } = await supabase
                .from('posts')
                .select(`
                    id, content, image, created_at, user_id,
                    users!posts_user_id_fkey(username, profile_picture),
                    comments(
                        id, content, created_at, user_id,
                        users!comments_user_id_fkey(username, profile_picture)
                    ),
                    likes(count)
                `)
                .order('created_at', { ascending: false });
            if (error) {
                console.error('Load feed error:', error.message);
                alert('Failed to load feed: ' + error.message);
                return;
            }
            console.log('Fetched posts:', data);

            const postsDiv = document.getElementById('posts');
            postsDiv.innerHTML = '';
            const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));

            if (!data || data.length === 0) {
                postsDiv.innerHTML = '<p>No posts yet.</p>';
                return;
            }

            data.forEach(post => {
                const likeCount = post.likes[0]?.count || 0;
                const postDate = new Date(post.created_at).toLocaleString('en-US', { 
                    timeZone: 'Asia/Kolkata',
                    year: 'numeric', month: 'short', day: 'numeric', 
                    hour: '2-digit', minute: '2-digit', hour12: true 
                });
                const postDiv = document.createElement('div');
                postDiv.className = `post ${post.users.username}`;
                postDiv.innerHTML = `
                    <img src="${post.users.profile_picture || placeholderImage}" alt="DP" class="post-dp">
                    <div class="post-content">
                        <p><strong>${post.users.username}</strong>: ${post.content || '(No text)'}</p>
                        ${post.image ? `<img src="${post.image}" alt="Post Image">` : ''}
                        <p class="timestamp">Posted on ${postDate}</p>
                        <p>Likes: ${likeCount}</p>
                        <button class="like-btn" data-post-id="${post.id}">❤️</button>
                        ${loggedInUser.id === post.user_id ? `<button class="delete-btn" data-post-id="${post.id}">🗑️</button>` : ''}
                        <div class="comments">
                            ${post.comments.map(c => {
                                const commentDate = new Date(c.created_at).toLocaleString('en-US', { 
                                    timeZone: 'Asia/Kolkata',
                                    year: 'numeric', month: 'short', day: 'numeric', 
                                    hour: '2-digit', minute: '2-digit', hour12: true 
                                });
                                return `
                                    <div class="comment">
                                        <img src="${c.users.profile_picture || placeholderImage}" alt="DP" class="comment-dp">
                                        <div class="comment-content">
                                            <p><strong>${c.users.username}</strong> commented: ${c.content}</p>
                                            <p class="timestamp">${commentDate}</p>
                                            ${loggedInUser.id === c.user_id ? `<button class="delete-btn" data-comment-id="${c.id}">🗑️</button>` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <form class="comment-form" data-post-id="${post.id}">
                            <input type="text" class="comment-input" placeholder="Add a comment..." required>
                            <button type="submit" class="comment-btn">💬</button>
                        </form>
                    </div>
                `;
                postsDiv.appendChild(postDiv);
            });

            document.querySelectorAll('.like-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const postId = btn.getAttribute('data-post-id');
                    await likePost(postId, loggedInUser.id);
                });
            });

            document.querySelectorAll('.delete-btn[data-post-id]').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const postId = btn.getAttribute('data-post-id');
                    await deletePost(postId);
                });
            });

            document.querySelectorAll('.delete-btn[data-comment-id]').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const commentId = btn.getAttribute('data-comment-id');
                    await deleteComment(commentId);
                });
            });

            document.querySelectorAll('.comment-form').forEach(form => {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const postId = form.getAttribute('data-post-id');
                    const content = form.querySelector('.comment-input').value.trim();
                    if (!content) {
                        alert('Please enter a comment.');
                        return;
                    }
                    await addComment(postId, loggedInUser.id, content);
                    form.reset();
                });
            });
        }

        async function likePost(postId, userId) {
            const { data, error } = await supabase
                .from('likes')
                .insert([{ post_id: postId, user_id: userId }])
                .select();
            if (error && error.code !== '23505') {
                console.error('Like error:', error.message);
                alert('Failed to like: ' + error.message);
            } else {
                console.log('Like added:', data);
            }
            loadFeed();
        }

        async function addComment(postId, userId, content) {
            const { data, error } = await supabase
                .from('comments')
                .insert([{ post_id: postId, user_id: userId, content }])
                .select();
            if (error) {
                console.error('Comment error:', error.message);
                alert('Failed to comment: ' + error.message);
            } else {
                console.log('Comment added:', data);
            }
            loadFeed();
        }

        async function deletePost(postId) {
            // Delete associated likes first
            const { error: likesError } = await supabase
                .from('likes')
                .delete()
                .eq('post_id', postId);
            if (likesError) {
                console.error('Delete likes error:', likesError.message);
                alert('Failed to delete likes: ' + likesError.message);
                return;
            }

            // Then delete associated comments
            const { error: commentError } = await supabase
                .from('comments')
                .delete()
                .eq('post_id', postId);
            if (commentError) {
                console.error('Delete comments error:', commentError.message);
                alert('Failed to delete comments: ' + commentError.message);
                return;
            }

            // Finally delete the post
            const { data, error } = await supabase
                .from('posts')
                .delete()
                .eq('id', postId);
            if (error) {
                console.error('Delete post error:', error.message);
                alert('Failed to delete post: ' + error.message);
            } else {
                console.log('Post deleted:', postId);
            }
            loadFeed();
        }

        async function deleteComment(commentId) {
            const { data, error } = await supabase
                .from('comments')
                .delete()
                .eq('id', commentId);
            if (error) {
                console.error('Delete comment error:', error.message);
                alert('Failed to delete comment: ' + error.message);
            } else {
                console.log('Comment deleted:', commentId);
            }
            loadFeed();
        }

        function subscribeToUpdates() {
            const channel = supabase
                .channel('public-changes')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'posts' }, () => loadFeed())
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'comments' }, () => loadFeed())
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'likes' }, () => loadFeed())
                .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'posts' }, () => loadFeed())
                .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'comments' }, () => loadFeed())
                .subscribe((status) => console.log('Subscription status:', status));
        }
    </script>
</body>
</html>
