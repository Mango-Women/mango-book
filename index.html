<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mango Social</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Sacramento&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
    <style>
        body {
            background: linear-gradient(45deg, #1a0033, #330066, #4d0099);
            min-height: 100vh;
            font-family: 'Roboto', sans-serif;
            color: #fff;
            overflow-y: auto;
            margin: 0;
            padding: 2vw;
            font-size: 14px;
        }
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: url('https://images.pexels.com/photos/957040/night-sky-stars-milky-way-cosmos-957040.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1');
            background-size: cover;
            opacity: 0.25;
            animation: cosmicPulse 20s infinite ease-in-out;
            z-index: -1;
        }
        .app {
            background: rgba(255, 255, 255, 0.15);
            width: 90vw;
            max-width: 700px;
            border-radius: 20px;
            padding: 3vw;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 40px rgba(255, 153, 255, 0.4);
            margin: 0 auto;
        }
        input, textarea {
            width: 100%;
            margin: 1vw 0;
            padding: 1vw;
            border-radius: 8px;
            border: 1px solid rgba(255, 215, 0, 0.4);
            background: linear-gradient(45deg, rgba(75, 0, 130, 0.3), rgba(255, 215, 0, 0.2), rgba(255, 69, 0, 0.3));
            color: #fff;
            font-family: 'Roboto', sans-serif;
            box-sizing: border-box;
            font-size: 12px;
        }
        textarea {
            resize: vertical;
            min-height: 8vw;
        }
        button {
            background: linear-gradient(45deg, #4B0082, #FFD700, #FF4500);
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 0.8vw 1.5vw;
            font-size: 12px;
        }
        button:hover {
            background: linear-gradient(45deg, #3A0066, #FFC107, #E63900);
            transform: scale(1.02);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
        }
        .profile-section {
            text-align: center;
            margin-bottom: 2vw;
            padding-bottom: 2vw;
            border-bottom: 1px solid rgba(255, 255, 255, 0.4);
            position: relative;
            padding-top: 15vw;
        }
        .profile-dp {
            width: clamp(50px, 12vw, 80px);
            height: clamp(50px, 12vw, 80px);
            border-radius: 50%;
            object-fit: cover;
            object-position: center;
            position: absolute;
            top: 2vw;
            left: 50%;
            transform: translateX(-50%);
            border: 2px solid rgba(255, 255, 255, 0.6);
        }
        #profileUsername {
            font-family: 'Sacramento', cursive;
            font-size: 24px;
        }
        .call-buttons {
            text-align: center;
            margin: 1vw 0;
        }
        .call-btn, .video-call-btn, .start-media-btn {
            margin: 0 1vw;
            padding: 0.5vw 1vw;
            font-size: 12px;
            display: inline-block;
        }
        .post-dp, .comment-dp {
            width: clamp(25px, 5vw, 35px);
            height: clamp(25px, 5vw, 35px);
            border-radius: 50%;
            object-fit: cover;
            object-position: center;
            margin-right: 1vw;
        }
        .post-content img {
            max-width: 100%;
            max-height: 35vw;
            object-fit: contain;
            margin-top: 1vw;
        }
        .delete-btn, .like-btn, .comment-btn {
            margin: 0.5vw;
            padding: 0.5vw;
            font-size: 12px;
            width: auto;
            display: inline-block;
            min-width: 25px;
        }
        .timestamp {
            font-size: 10px;
            color: #ccc;
        }
        .feed {
            overflow-y: auto;
            padding-right: 1vw;
        }
        .post {
            background: rgba(255, 255, 255, 0.2);
            padding: 2vw;
            margin: 2vw 0;
            border-radius: 10px;
            display: flex;
            align-items: flex-start;
            border: 1px solid rgba(255, 255, 255, 0.4);
        }
        .comment {
            background: rgba(255, 255, 255, 0.15);
            padding: 1.5vw;
            margin: 1vw 0 0 clamp(15px, 4vw, 40px);
            border-radius: 8px;
            display: flex;
            align-items: flex-start;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        #incomingCallModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            z-index: 1001;
            text-align: center;
            max-width: 300px;
            width: 90%;
        }
        #callModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
            max-width: 600px;
            width: 90%;
            text-align: center;
        }
        #localVideo, #remoteVideo {
            width: 100%;
            max-width: 280px;
            height: auto;
            margin: 10px auto;
            border-radius: 8px;
            background: rgba(75, 0, 130, 0.3);
            object-fit: cover;
            display: block;
        }
        #callStatus {
            font-size: 16px;
            margin-bottom: 10px;
        }
        #callModal button, #incomingCallModal button {
            margin: 5px;
            padding: 10px 20px;
        }
        @keyframes cosmicPulse {
            0%, 100% { opacity: 0.25; }
            50% { opacity: 0.35; }
        }
        @media (max-width: 600px) {
            .app { padding: 4vw; }
            .post, .comment { flex-direction: column; align-items: stretch; }
            .post-dp, .comment-dp { margin-bottom: 1vw; }
            button { padding: 2vw 3vw; }
            #profileUsername { font-size: 20px; }
            #localVideo, #remoteVideo { max-width: 100%; }
        }
    </style>
</head>
<body>
    <div id="loginContainer" class="app">
        <h1>Login to Mangoes Book</h1>
        <form id="loginForm">
            <label for="username">Username:</label>
            <input type="text" id="username" placeholder="mango1 or mango2" required>
            <label for="password">Password:</label>
            <input type="password" id="password" placeholder="mango1726" required>
            <button type="submit">Login</button>
        </form>
    </div>

    <div id="mainContainer" class="app" style="display: none;">
        <div class="call-buttons">
            <button id="startVoiceMediaBtn" class="start-media-btn">Start Voice</button>
            <button id="startVideoMediaBtn" class="start-media-btn">Start Video</button>
            <button id="callBtn" class="call-btn" style="display: none;">üìû Voice Call</button>
            <button id="videoCallBtn" class="video-call-btn" style="display: none;">üé• Video Call</button>
        </div>
        <div class="profile-section">
            <img id="profilePicture" alt="Profile Picture" class="profile-dp">
            <h2 id="profileUsername"></h2>
            <p id="profileBio"></p>
            <button id="editProfileBtn">Edit Profile</button>
            <button id="logoutBtn">Logout</button>
            <button id="clearDataBtn">Clear All Data</button>
        </div>

        <form id="editProfileForm" style="display: none;">
            <input type="text" id="editUsername" placeholder="Username">
            <textarea id="editBio" placeholder="Bio"></textarea>
            <input type="file" id="editProfilePic" accept="image/*">
            <button type="submit">Save Profile</button>
        </form>

        <form id="postForm">
            <textarea id="postContent" placeholder="What's on your mind?"></textarea>
            <input type="file" id="postImage" accept="image/*">
            <button type="submit">Post</button>
        </form>

        <div id="posts" class="feed"></div>
    </div>

    <div id="incomingCallModal">
        <h3 id="incomingCallStatus">Incoming Call...</h3>
        <button id="acceptIncomingCall">Accept</button>
        <button id="rejectIncomingCall">Reject</button>
    </div>

    <div id="callModal">
        <h3 id="callStatus">Call in Progress...</h3>
        <video id="localVideo" autoplay playsinline muted></video>
        <video id="remoteVideo" autoplay playsinline></video>
        <button id="endCall">End Call</button>
    </div>

    <script>
        const supabaseUrl = 'https://rukbvbwjfyktrdvvodir.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1a2J2YndqZnlrdHJkdnZvZGlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE3MDE1NjAsImV4cCI6MjA1NzI3NzU2MH0._A8EPmKwdaGnFhvhiZJUZ3nvkQrKkCfzmiOhO8JC1vc';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        const users = [
            { id: '566e8b0b-a07a-4442-b18d-2a3ca87f7992', username: 'mango1', password: 'mango1726', bio: '', profile_picture: '' },
            { id: 'f960d7a8-ec35-4ff6-910a-6571c8b74caa', username: 'mango2', password: 'mango1726', bio: '', profile_picture: '' }
        ];

        const placeholderImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAAAXNSR0IArs4c6QAAAJBJREFUOE9jZKAyYCRkZGQgy8DAwMDAwMjAwMjIyMDAwMDAwMjAwMjIyMDAwMDAwMjAwMjIyMDAwMDAwMjAwMjIyMDAwMDAwMjAwMjIyMDAwMDAwMjAwMjIyMDAwMDAwMjAwMjIyMDAwMDAwMjAwMjIyMDAwMDAwMjAwMjIyMDAwMDAwMjAwMjIyMDAwMDAwMjAwMjIyMAAAADs=';

        let localStream;
        let peerConnection;
        const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        let targetUserId;
        let callSubscription = null;
        let updatesSubscription = null;
        let processedCallIds = new Set();
        let currentCallType = 'voice';
        let mediaStarted = false;
        let mediaType = null;

        function formatIST(date) {
            return new Date(date).toLocaleString('en-US', {
                timeZone: 'Asia/Kolkata',
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('App loaded at', new Date().toISOString());
            const isFreshLogin = sessionStorage.getItem('justLoggedIn');
            if (!isFreshLogin) {
                localStorage.removeItem('loggedInUser');
                document.getElementById('loginContainer').style.display = 'block';
                document.getElementById('mainContainer').style.display = 'none';
            } else {
                const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
                if (loggedInUser) {
                    initUser(loggedInUser);
                }
            }
        });

        function initUser(user) {
            console.log('Initializing user:', user);
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
            loadProfile(user);
            setupCallButtons(user);
            loadFeed();
            subscribeToUpdates();
            subscribeToCalls(user);
            setInterval(() => checkPendingCalls(user), 1000);
            // Clear processedCallIds every 30s to prevent blocking
            setInterval(() => {
                console.log('Clearing processedCallIds');
                processedCallIds.clear();
            }, 30000);
        }

        async function loadProfile(user) {
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('username, bio, profile_picture')
                    .eq('id', user.id)
                    .single();
                if (error && error.code !== 'PGRST116') {
                    console.error('Profile error:', error.message);
                    return;
                }
                const profileData = data || user;
                document.getElementById('profileUsername').textContent = profileData.username;
                document.getElementById('profileBio').textContent = profileData.bio || 'No bio yet';
                document.getElementById('profilePicture').src = profileData.profile_picture || placeholderImage;
            } catch (error) {
                console.error('Profile load exception:', error.message);
            }
        }

        function setupCallButtons(loggedInUser) {
            const otherUser = users.find(u => u.id !== loggedInUser.id);
            if (otherUser) {
                targetUserId = otherUser.id;
                console.log('Target user:', otherUser);
            }
        }

        async function loadFeed() {
            try {
                const { data, error } = await supabase
                    .from('posts')
                    .select(`
                        id, content, image, created_at, user_id,
                        users!posts_user_id_fkey(id, username, profile_picture)
                    `)
                    .order('created_at', { ascending: false });
                if (error) {
                    console.error('Feed error:', error.message);
                    return;
                }
                console.log('Fetched posts:', data);
                const postsDiv = document.getElementById('posts');
                postsDiv.innerHTML = '';
                const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
                console.log('Logged in user:', loggedInUser);

                if (!data || data.length === 0) {
                    postsDiv.innerHTML = 'No posts yet.';
                    return;
                }

                data.forEach(post => {
                    const postDate = formatIST(post.created_at);
                    const postUsername = post.users?.username || 'Unknown';
                    const postUserId = post.users?.id || post.user_id;
                    console.log(`Rendering post ${post.id}: user_id=${post.user_id}, username=${postUsername}`);
                    const postDiv = document.createElement('div');
                    postDiv.className = `post ${postUsername}`;
                    postDiv.innerHTML = `
                        <img src="${post.users?.profile_picture || placeholderImage}" alt="Post DP" class="post-dp">
                        <div class="post-content">
                            <p><strong>${postUsername}</strong>: ${post.content || '(No text)'}</p>
                            ${post.image ? `<img src="${post.image}" alt="Post Image">` : ''}
                            <p class="timestamp">Posted on ${postDate}</p>
                            <button class="like-btn" data-post-id="${post.id}">‚ù§Ô∏è</button>
                            ${loggedInUser.id === post.user_id ? `<button class="delete-btn" data-post-id="${post.id}">üóëÔ∏è</button>` : ''}
                            <form class="comment-form" data-post-id="${post.id}">
                                <input type="text" class="comment-input" placeholder="Add a comment..." required>
                                <button type="submit" class="comment-btn">üí¨</button>
                            </form>
                        </div>
                    `;
                    postsDiv.appendChild(postDiv);
                });

                document.querySelectorAll('.like-btn').forEach(btn => {
                    btn.addEventListener('click', () => likePost(btn.getAttribute('data-post-id'), loggedInUser.id));
                });

                document.querySelectorAll('.delete-btn[data-post-id]').forEach(btn => {
                    btn.addEventListener('click', () => deletePost(btn.getAttribute('data-post-id')));
                });

                document.querySelectorAll('.comment-form').forEach(form => {
                    form.addEventListener('submit', async e => {
                        e.preventDefault();
                        const postId = form.getAttribute('data-post-id');
                        const content = form.querySelector('.comment-input').value.trim();
                        if (content) {
                            await addComment(postId, loggedInUser.id, content);
                            form.reset();
                        }
                    });
                });
            } catch (error) {
                console.error('Feed load exception:', error.message);
            }
        }

        document.getElementById('loginForm').addEventListener('submit', e => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const user = users.find(u => u.username === username && u.password === password);
            if (user) {
                console.log('Login successful:', user);
                localStorage.setItem('loggedInUser', JSON.stringify(user));
                sessionStorage.setItem('justLoggedIn', 'true');
                initUser(user);
            } else {
                alert('Invalid credentials. Use mango1 or mango2 with password mango1726.');
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            console.log('Logging out');
            if (updatesSubscription) supabase.removeChannel(updatesSubscription);
            if (callSubscription) supabase.removeChannel(callSubscription);
            localStorage.removeItem('loggedInUser');
            sessionStorage.removeItem('justLoggedIn');
            document.getElementById('mainContainer').style.display = 'none';
            document.getElementById('loginContainer').style.display = 'block';
            endCall();
        });

        document.getElementById('editProfileBtn').addEventListener('click', () => {
            const user = JSON.parse(localStorage.getItem('loggedInUser'));
            document.getElementById('editUsername').value = user.username;
            document.getElementById('editBio').value = user.bio || '';
            document.getElementById('editProfileForm').style.display = 'block';
        });

        document.getElementById('editProfileForm').addEventListener('submit', async e => {
            e.preventDefault();
            const user = JSON.parse(localStorage.getItem('loggedInUser'));
            const newUsername = document.getElementById('editUsername').value;
            const newBio = document.getElementById('editBio').value;
            const file = document.getElementById('editProfilePic').files[0];
            let profilePictureUrl = user.profile_picture || placeholderImage;

            try {
                if (file) {
                    const filePath = `${user.id}/${Date.now()}_${file.name}`;
                    const { error } = await supabase.storage
                        .from('profile-pics')
                        .upload(filePath, file, { upsert: true });
                    if (error) throw new Error(`Upload error: ${error.message}`);
                    profilePictureUrl = supabase.storage.from('profile-pics').getPublicUrl(filePath).data.publicUrl;
                }

                user.username = newUsername;
                user.bio = newBio;
                user.profile_picture = profilePictureUrl;
                localStorage.setItem('loggedInUser', JSON.stringify(user));

                const { error } = await supabase.from('users').upsert({
                    id: user.id,
                    username: newUsername,
                    bio: newBio,
                    profile_picture: profilePictureUrl
                }, { onConflict: 'id' });
                if (error) throw new Error(`Upsert error: ${error.message}`);

                loadProfile(user);
                loadFeed();
                document.getElementById('editProfileForm').style.display = 'none';
            } catch (error) {
                console.error('Profile update error:', error.message);
                alert('Failed to update profile: ' + error.message);
            }
        });

        document.getElementById('postForm').addEventListener('submit', async e => {
            e.preventDefault();
            const user = JSON.parse(localStorage.getItem('loggedInUser'));
            const content = document.getElementById('postContent').value.trim();
            const file = document.getElementById('postImage').files[0];
            let imageUrl = null;

            if (!content && !file) {
                alert('Post content or image required.');
                return;
            }

            try {
                console.log('Posting as', user);
                if (file) {
                    const filePath = `${user.id}/${Date.now()}_${file.name}`;
                    const { error } = await supabase.storage
                        .from('profile-pics')
                        .upload(filePath, file, { upsert: true });
                    if (error) throw new Error(`Upload error: ${error.message}`);
                    imageUrl = supabase.storage.from('profile-pics').getPublicUrl(filePath).data.publicUrl;
                }

                const { data, error } = await supabase
                    .from('posts')
                    .insert([{ user_id: user.id, content: content || '', image: imageUrl }])
                    .select();
                if (error) throw new Error(`Post error: ${error.message}`);
                console.log('Post inserted:', data[0]);
                document.getElementById('postForm').reset();
                loadFeed();
            } catch (error) {
                console.error('Post error:', error.message);
                alert('Failed to post: ' + error.message);
            }
        });

        document.getElementById('clearDataBtn').addEventListener('click', async () => {
            if (!confirm('Are you sure you want to clear all data?')) return;
            try {
                await supabase.from('likes').delete().match({});
                await supabase.from('comments').delete().match({});
                await supabase.from('posts').delete().match({});
                await supabase.from('calls').delete().match({});
                const { data: files } = await supabase.storage.from('profile-pics').list();
                if (files && files.length > 0) {
                    await supabase.storage.from('profile-pics').remove(files.map(f => f.name));
                }
                const user = JSON.parse(localStorage.getItem('loggedInUser'));
                user.profile_picture = placeholderImage;
                user.bio = '';
                localStorage.setItem('loggedInUser', JSON.stringify(user));
                await supabase.from('users').upsert({ 
                    id: user.id, 
                    username: user.username, 
                    bio: '', 
                    profile_picture: placeholderImage 
                });
                loadProfile(user);
                loadFeed();
            } catch (error) {
                console.error('Clear data error:', error.message);
                alert('Failed to clear data: ' + error.message);
            }
        });

        async function likePost(postId, userId) {
            try {
                const { data, error } = await supabase
                    .from('likes')
                    .insert([{ post_id: postId, user_id: userId }])
                    .select();
                if (error && error.code !== '23505') throw new Error(`Like error: ${error.message}`);
                loadFeed();
            } catch (error) {
                console.error('Like error:', error.message);
            }
        }

        async function addComment(postId, userId, content) {
            try {
                const { data, error } = await supabase
                    .from('comments')
                    .insert([{ post_id: postId, user_id: userId, content }])
                    .select();
                if (error) throw new Error(`Comment error: ${error.message}`);
                loadFeed();
            } catch (error) {
                console.error('Comment error:', error.message);
            }
        }

        async function deletePost(postId) {
            try {
                await supabase.from('likes').delete().eq('post_id', postId);
                await supabase.from('comments').delete().eq('post_id', postId);
                await supabase.from('posts').delete().eq('id', postId);
                loadFeed();
            } catch (error) {
                console.error('Delete post error:', error.message);
            }
        }

        async function deleteComment(commentId) {
            try {
                await supabase.from('comments').delete().eq('id', commentId);
                loadFeed();
            } catch (error) {
                console.error('Delete comment error:', error.message);
            }
        }

        async function startMedia(isVideo = false) {
            try {
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    localStream = null;
                }
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    },
                    video: isVideo ? { width: { ideal: 640 }, height: { ideal: 480 } } : false
                });
                document.getElementById('localVideo').srcObject = localStream;
                document.getElementById('localVideo').style.display = isVideo ? 'block' : 'none';
                document.getElementById('remoteVideo').style.display = isVideo ? 'block' : 'none';
                mediaStarted = true;
                mediaType = isVideo ? 'video' : 'voice';
                console.log(`Media started: ${mediaType}`);
                document.getElementById('callBtn').style.display = mediaType === 'voice' ? 'inline-block' : 'none';
                document.getElementById('videoCallBtn').style.display = mediaType === 'video' ? 'inline-block' : 'none';
                document.getElementById('startVoiceMediaBtn').disabled = mediaType === 'voice';
                document.getElementById('startVideoMediaBtn').disabled = mediaType === 'video';
                document.getElementById('callStatus').textContent = `${mediaType.charAt(0).toUpperCase() + mediaType.slice(1)} ready.`;
                return true;
            } catch (error) {
                console.error('Media error:', error.name, error.message);
                let message = 'Error accessing media.';
                if (error.name === 'NotFoundError') message = 'No camera/microphone found.';
                else if (error.name === 'NotAllowedError') message = 'Permission denied. Allow camera/microphone in browser settings.';
                else if (error.name === 'SecurityError') message = 'Media requires HTTPS.';
                else message = `Error: ${error.message}`;
                document.getElementById('callStatus').textContent = message;
                alert(message);
                mediaStarted = false;
                mediaType = null;
                return false;
            }
        }

        async function callUser(isVideo = false) {
            if (!mediaStarted || !localStream) {
                alert('Please start media first.');
                return;
            }
            if ((isVideo && mediaType !== 'video') || (!isVideo && mediaType !== 'voice')) {
                alert(`Please start ${isVideo ? 'video' : 'voice'} media.`);
                return;
            }
            const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
            currentCallType = isVideo ? 'video' : 'voice';

            try {
                console.log('Initiating call as', loggedInUser);
                peerConnection = new RTCPeerConnection(config);
                localStream.getTracks().forEach(track => {
                    console.log('Adding track:', track.kind);
                    peerConnection.addTrack(track, localStream);
                });
                const remoteStream = new MediaStream();
                document.getElementById('remoteVideo').srcObject = remoteStream;

                peerConnection.ontrack = event => {
                    console.log('Received remote track:', event.track.kind);
                    event.streams[0].getTracks().forEach(track => remoteStream.addTrack(track));
                };

                peerConnection.onicecandidate = event => {
                    if (event.candidate) {
                        console.log('Sending ICE candidate');
                        supabase.from('calls').insert({
                            sender_id: loggedInUser.id,
                            receiver_id: targetUserId,
                            type: 'ice-candidate',
                            data: JSON.stringify(event.candidate)
                        }).then(() => console.log('ICE candidate sent'))
                          .catch(error => console.error('ICE candidate error:', error.message));
                    }
                };

                peerConnection.oniceconnectionstatechange = () => {
                    console.log('ICE state:', peerConnection.iceConnectionState);
                    if (peerConnection.iceConnectionState === 'failed') {
                        document.getElementById('callStatus').textContent = 'Connection failed.';
                        endCall();
                    }
                };

                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                console.log('Inserting offer:', { sender_id: loggedInUser.id, receiver_id: targetUserId, type: currentCallType });
                const { data, error } = await supabase.from('calls').insert({
                    sender_id: loggedInUser.id,
                    receiver_id: targetUserId,
                    type: 'offer',
                    data: JSON.stringify(offer)
                }).select();
                if (error) throw new Error(`Offer error: ${error.message}`);
                console.log('Offer inserted:', data[0]);
                document.getElementById('callStatus').textContent = `Calling ${users.find(u => u.id === targetUserId).username}...`;
                document.getElementById('callModal').style.display = 'block';
                document.getElementById('localVideo').style.display = isVideo ? 'block' : 'none';
                document.getElementById('remoteVideo').style.display = isVideo ? 'block' : 'none';
            } catch (error) {
                console.error('Call error:', error.message);
                document.getElementById('callStatus').textContent = 'Failed to initiate call: ' + error.message;
                endCall();
            }
        }

        async function checkPendingCalls(user) {
            console.log(`Polling calls for ${user.username} (id: ${user.id})`);
            try {
                const { data, error } = await supabase
                    .from('calls')
                    .select('*')
                    .eq('receiver_id', user.id)
                    .eq('type', 'offer')
                    .order('created_at', { ascending: false })
                    .limit(1);
                if (error) {
                    console.error('Polling error:', error.message);
                    return;
                }
                console.log('Polling result:', data);
                if (data && data.length > 0 && !processedCallIds.has(data[0].id)) {
                    console.log('Found call:', data[0]);
                    showIncomingCallModal(data[0]);
                    processedCallIds.add(data[0].id);
                }
            } catch (error) {
                console.error('Polling exception:', error.message);
            }
        }

        function showIncomingCallModal(call) {
            console.log('Showing modal for call:', call);
            const sender = users.find(u => u.id === call.sender_id);
            const senderUsername = sender ? sender.username : 'Unknown';
            const isVideo = typeof call.data === 'string' ? call.data.includes('m=video') : call.data?.sdp?.includes('m=video');
            document.getElementById('incomingCallStatus').textContent = `Incoming ${isVideo ? 'Video' : 'Voice'} Call from ${senderUsername}`;
            document.getElementById('incomingCallModal').style.display = 'block';

            const acceptBtn = document.getElementById('acceptIncomingCall');
            const rejectBtn = document.getElementById('rejectIncomingCall');
            const newAccept = acceptBtn.cloneNode(true);
            const newReject = rejectBtn.cloneNode(true);
            acceptBtn.parentNode.replaceChild(newAccept, acceptBtn);
            rejectBtn.parentNode.replaceChild(newReject, rejectBtn);

            newAccept.onclick = async () => {
                console.log('Accepting call:', call.id);
                const isVideo = typeof call.data === 'string' ? call.data.includes('m=video') : call.data?.sdp?.includes('m=video');
                if (!mediaStarted || (isVideo && mediaType !== 'video') || (!isVideo && mediaType !== 'voice')) {
                    console.log('Starting media:', isVideo ? 'video' : 'voice');
                    const success = await startMedia(isVideo);
                    if (!success) {
                        alert(`Failed to start ${isVideo ? 'video' : 'voice'} media.`);
                        document.getElementById('incomingCallModal').style.display = 'none';
                        await supabase.from('calls').delete().eq('id', call.id);
                        return;
                    }
                }
                try {
                    await handleIncomingCall(call);
                    document.getElementById('incomingCallModal').style.display = 'none';
                    await supabase.from('calls').delete().eq('id', call.id);
                } catch (error) {
                    console.error('Accept error:', error.message);
                    alert('Failed to accept call: ' + error.message);
                    endCall();
                }
            };

            newReject.onclick = async () => {
                console.log('Rejecting call:', call.id);
                document.getElementById('incomingCallModal').style.display = 'none';
                await supabase.from('calls').delete().eq('id', call.id);
            };
        }

        async function handleIncomingCall(call) {
            console.log('Handling call:', call);
            let offer;
            try {
                offer = typeof call.data === 'string' ? JSON.parse(call.data) : call.data;
            } catch (error) {
                console.error('Parse error:', error.message);
                throw new Error('Invalid call data');
            }

            const isVideo = offer.sdp.includes('m=video');
            currentCallType = isVideo ? 'video' : 'voice';

            peerConnection = new RTCPeerConnection(config);
            localStream.getTracks().forEach(track => {
                console.log('Adding track:', track.kind);
                peerConnection.addTrack(track, localStream);
            });
            const remoteStream = new MediaStream();
            document.getElementById('remoteVideo').srcObject = remoteStream;

            peerConnection.ontrack = event => {
                console.log('Received remote track:', event.track.kind);
                event.streams[0].getTracks().forEach(track => remoteStream.addTrack(track));
            };

            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    console.log('Sending ICE candidate');
                    supabase.from('calls').insert({
                        sender_id: JSON.parse(localStorage.getItem('loggedInUser')).id,
                        receiver_id: call.sender_id,
                        type: 'ice-candidate',
                        data: JSON.stringify(event.candidate)
                    }).then(() => console.log('ICE candidate sent'))
                      .catch(error => console.error('ICE candidate error:', error.message));
                }
            };

            peerConnection.oniceconnectionstatechange = () => {
                console.log('ICE state:', peerConnection.iceConnectionState);
                if (peerConnection.iceConnectionState === 'failed') {
                    document.getElementById('callStatus').textContent = 'Connection failed.';
                    endCall();
                }
            };

            try {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
                const { error } = await supabase.from('calls').insert({
                    sender_id: loggedInUser.id,
                    receiver_id: call.sender_id,
                    type: 'answer',
                    data: JSON.stringify(answer)
                });
                if (error) throw new Error(`Answer error: ${error.message}`);
                console.log('Answer sent');
                document.getElementById('callStatus').textContent = `Connected with ${users.find(u => u.id === call.sender_id).username}`;
                document.getElementById('callModal').style.display = 'block';
                document.getElementById('localVideo').style.display = isVideo ? 'block' : 'none';
                document.getElementById('remoteVideo').style.display = isVideo ? 'block' : 'none';
            } catch (error) {
                console.error('Handle call error:', error.message);
                throw error;
            }
        }

        function endCall() {
            console.log('Ending call');
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            document.getElementById('callModal').style.display = 'none';
            document.getElementById('incomingCallModal').style.display = 'none';
            document.getElementById('localVideo').srcObject = null;
            document.getElementById('remoteVideo').srcObject = null;
            document.getElementById('localVideo').style.display = '';
            document.getElementById('remoteVideo').style.display = 'none';
            mediaStarted = false;
            mediaType = null;
            document.getElementById('startVoiceMediaBtn').disabled = false;
            document.getElementById('startVideoMediaBtn').disabled = false;
            document.getElementById('callBtn').style.display = 'none';
            document.getElementById('videoCallBtn').style.display = 'none';
            document.getElementById('callStatus').innerText = 'Call ended';
        }

        function subscribeToUpdates() {
            if (updatesSubscription) supabase.removeChannel(updatesSubscription);
            updatesSubscription = supabase
                .channel('public_updates')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'posts' }, () => {
                    console.log('New post detected');
                    loadFeed();
                })
                .subscribe((status, error) => {
                    console.log('Updates subscription:', status);
                    if (error) console.error('Updates error:', error.message);
                });
        }

        function subscribeToCalls(user) {
            if (callSubscription) supabase.removeChannel(callSubscription);
            callSubscription = supabase
                .channel('calls')
                .on('postgres_changes', { 
                    event: 'INSERT', 
                    schema: 'public', 
                    table: 'calls', 
                    filter: `receiver_id=eq.${user.id}`
                }, payload => {
                    const call = payload.new;
                    console.log('New call received:', call);
                    if (!processedCallIds.has(call.id)) {
                        if (call.type === 'offer') {
                            console.log('Processing offer:', call);
                            showIncomingCallModal(call);
                            processedCallIds.add(call.id);
                        } else if (call.type === 'answer' && peerConnection) {
                            console.log('Received answer:', call.data);
                            try {
                                const answer = typeof call.data === 'string' ? JSON.parse(call.data) : call.data;
                                peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                                console.log('Answer applied');
                            } catch (error) {
                                console.error('Answer error:', error.message);
                            }
                        } else if (call.type === 'ice-candidate' && peerConnection) {
                            console.log('Received ICE candidate:', call.data);
                            try {
                                const candidate = typeof call.data === 'string' ? JSON.parse(call.data) : call.data;
                                peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                                console.log('ICE candidate applied');
                            } catch (error) {
                                console.error('ICE candidate error:', error.message);
                            }
                        }
                    }
                })
                .subscribe((status, error) => {
                    console.log('Calls subscription:', status);
                    if (error) console.error('Calls error:', error);
                });
        }

        document.getElementById('startVoiceMediaBtn').addEventListener('click', () => startMedia(false));
        document.getElementById('startVideoMediaBtn').addEventListener('click', () => startMedia(true));
        document.getElementById('callBtn').addEventListener('click', () => callUser(false));
        document.getElementById('videoCallBtn').addEventListener('click', () => callUser(true));
        document.getElementById('endCall').addEventListener('click', endCall);
    </script>
</body>
</html>
